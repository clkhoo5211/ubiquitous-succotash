{% extends "base.html" %}

{% block title %}Sign Up - Decentralized Autonomous Forum{% endblock %}

{% block body_class %}auth-page{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <!-- Logo/Branding -->
        <div class="auth-card__header">
            <img src="{{ url_for('static', path='/images/logo.svg') }}" alt="Forum Logo" class="auth-card__logo">
            <h1 class="auth-card__title">Join the Community</h1>
            <p class="auth-card__subtitle">Create your account and start earning crypto rewards</p>
        </div>

        <!-- Error Message (from server) -->
        {% if request.query_params.get('error') %}
        <div class="alert alert--error">
            <p>{{ request.query_params.get('error') }}</p>
        </div>
        {% endif %}
        
        <!-- Success Message (from server) -->
        {% if request.query_params.get('success') %}
        <div class="alert alert--success">
            <p>{{ request.query_params.get('success') }}</p>
        </div>
        {% endif %}

        <!-- Registration Form -->
        <form action="/auth/register" method="POST" class="auth-form" id="register-form">
            <!-- Username Field -->
            <div class="form-group">
                <label for="username" class="form-label">Username</label>
                <input type="text"
                       id="username"
                       name="username"
                       class="form-input"
                       placeholder="Choose a unique username"
                       required
                       autocomplete="username"
                       pattern="[A-Za-z0-9_-]{3,50}"
                       minlength="3"
                       maxlength="50"
                       autofocus>
                <span class="form-help">3-50 characters, letters, numbers, underscore, hyphen only</span>
                <span class="form-error" id="username-error"></span>
            </div>

            <!-- Email Field -->
            <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input type="email"
                       id="email"
                       name="email"
                       class="form-input"
                       placeholder="your@email.com"
                       required
                       autocomplete="email">
                <span class="form-error" id="email-error"></span>
            </div>

            <!-- Password Field -->
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <div class="input-group">
                    <input type="password"
                           id="password"
                           name="password"
                           class="form-input"
                           placeholder="Create a strong password"
                           required
                           autocomplete="new-password"
                           minlength="8">
                    <button type="button" class="input-group__btn" id="toggle-password" aria-label="Toggle password visibility">
                        <svg width="20" height="20" class="eye-icon">
                            <path d="M1 10s3-6 9-6 9 6 9 6-3 6-9 6-9-6-9-6z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        </svg>
                    </button>
                </div>
                <div class="password-strength" id="password-strength">
                    <div class="password-strength__bar">
                        <div class="password-strength__fill" id="password-strength-fill"></div>
                    </div>
                    <span class="password-strength__text" id="password-strength-text"></span>
                </div>
                <span class="form-error" id="password-error"></span>
            </div>

            <!-- Confirm Password Field -->
            <div class="form-group">
                <label for="confirm_password" class="form-label">Confirm Password</label>
                <input type="password"
                       id="confirm_password"
                       name="confirm_password"
                       class="form-input"
                       placeholder="Re-enter your password"
                       required
                       autocomplete="new-password"
                       minlength="8">
                <span class="form-error" id="confirm-password-error"></span>
            </div>

            <!-- Age Confirmation (COPPA Compliance) -->
            <div class="form-group">
                <label class="checkbox">
                    <input type="checkbox" name="age_confirmation" id="age_confirmation" required>
                    <span class="checkbox__label">I confirm that I am at least 13 years old</span>
                </label>
                <span class="form-error" id="age-error"></span>
            </div>

            <!-- Terms & Privacy (GDPR/CCPA Compliance) -->
            <div class="form-group">
                <label class="checkbox">
                    <input type="checkbox" name="terms_agreement" id="terms_agreement" required>
                    <span class="checkbox__label">
                        I agree to the
                        <a href="/terms" target="_blank" class="form-link">Terms of Service</a>
                        and
                        <a href="/privacy" target="_blank" class="form-link">Privacy Policy</a>
                    </span>
                </label>
                <span class="form-error" id="terms-error"></span>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn--primary btn--lg btn--block" id="register-btn">
                <span class="btn__text">Create Account</span>
                <span class="btn__loader" style="display: none;">
                    <svg width="20" height="20" viewBox="0 0 20 20" class="spinner">
                        <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="40" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>

            <!-- Bonus Info -->
            <div class="form-info">
                <svg width="20" height="20" class="form-info__icon">
                    <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <path d="M10 10v4m0-8v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span class="form-info__text">
                    You'll receive <strong>+100 bonus points</strong> upon registration!
                </span>
            </div>
        </form>

        <!-- Divider -->
        <div class="auth-divider">
            <span class="auth-divider__text">Or sign up with</span>
        </div>

        <!-- OAuth2 Social Login -->
        <div class="oauth-buttons">
            <a href="/auth/oauth/meta" class="oauth-btn oauth-btn--meta">
                <svg class="oauth-btn__icon" width="20" height="20" viewBox="0 0 20 20">
                    <path d="M20 10c0-5.5-4.5-10-10-10S0 4.5 0 10c0 5 3.7 9.1 8.4 9.9v-7H5.9v-2.9h2.5V7.8c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.2.2 2.2.2v2.5h-1.3c-1.2 0-1.6.8-1.6 1.6v1.9h2.8l-.4 2.9h-2.3v7c4.7-.8 8.3-4.9 8.3-9.9z" fill="currentColor"/>
                </svg>
                Meta
            </a>
            <a href="/auth/oauth/reddit" class="oauth-btn oauth-btn--reddit">
                <svg class="oauth-btn__icon" width="20" height="20" viewBox="0 0 20 20">
                    <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2" fill="none"/>
                    <circle cx="7" cy="9" r="1.5" fill="currentColor"/>
                    <circle cx="13" cy="9" r="1.5" fill="currentColor"/>
                    <path d="M6 12c0 2.2 1.8 4 4 4s4-1.8 4-4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                </svg>
                Reddit
            </a>
            <a href="/auth/oauth/twitter" class="oauth-btn oauth-btn--twitter">
                <svg class="oauth-btn__icon" width="20" height="20" viewBox="0 0 20 20">
                    <use xlink:href="#icon-twitter"/>
                </svg>
                X (Twitter)
            </a>
        </div>

        <div class="oauth-buttons">
            <a href="/auth/oauth/discord" class="oauth-btn oauth-btn--discord">
                <svg class="oauth-btn__icon" width="20" height="20" viewBox="0 0 20 20">
                    <use xlink:href="#icon-discord"/>
                </svg>
                Discord
            </a>
            <a href="/auth/oauth/telegram" class="oauth-btn oauth-btn--telegram">
                <svg class="oauth-btn__icon" width="20" height="20" viewBox="0 0 20 20">
                    <use xlink:href="#icon-telegram"/>
                </svg>
                Telegram
            </a>
        </div>

        <!-- Login Link -->
        <div class="auth-card__footer">
            <p class="auth-card__footer-text">
                Already have an account?
                <a href="/auth/login" class="auth-card__link">Login here</a>
            </p>
        </div>
    </div>

    <!-- Info Panel (Side) -->
    <div class="auth-info">
        <h2 class="auth-info__title">What you get:</h2>
        <ul class="auth-info__list">
            <li class="auth-info__item">
                <svg class="auth-info__icon auth-info__icon--bonus" width="24" height="24">
                    <path d="M12 2l3 7h7l-5.5 4.5L19 21l-7-5-7 5 2.5-7.5L2 9h7l3-7z" fill="currentColor"/>
                </svg>
                <div>
                    <strong>+100 Welcome Bonus</strong>
                    <p>Start with 100 points to spend on posts and comments</p>
                </div>
            </li>
            <li class="auth-info__item">
                <svg class="auth-info__icon" width="24" height="24">
                    <use xlink:href="#icon-crypto"/>
                </svg>
                <div>
                    <strong>Earn BNB Cryptocurrency</strong>
                    <p>Redeem 10,000 points for 0.01 BNB</p>
                </div>
            </li>
            <li class="auth-info__item">
                <svg class="auth-info__icon" width="24" height="24">
                    <path d="M4 12l4 4 8-8" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 12c0 5.5 4.5 10 10 10s10-4.5 10-10S17.5 2 12 2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                </svg>
                <div>
                    <strong>Level Progression System</strong>
                    <p>New User → Active → Trusted → Moderator → Senior Moderator</p>
                </div>
            </li>
            <li class="auth-info__item">
                <svg class="auth-info__icon" width="24" height="24">
                    <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M9 3v18M3 9h18M3 15h18" stroke="currentColor" stroke-width="2"/>
                </svg>
                <div>
                    <strong>No Ads, Ever</strong>
                    <p>Community-funded, no advertising or tracking</p>
                </div>
            </li>
        </ul>

        <!-- Privacy Badge -->
        <div class="auth-info__badge">
            <svg width="16" height="16" class="auth-info__badge-icon">
                <path d="M8 1L3 3v5c0 3 2 6 5 7 3-1 5-4 5-7V3l-5-2z" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                <path d="M6 8l1.5 1.5L11 6" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="auth-info__badge-text">GDPR & CCPA Compliant</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Toggle password visibility
document.getElementById('toggle-password').addEventListener('click', function() {
    const passwordInput = document.getElementById('password');
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    this.querySelector('.eye-icon').style.opacity = type === 'text' ? '0.6' : '1';
});

// Password strength indicator
document.getElementById('password').addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('password-strength-fill');
    const strengthText = document.getElementById('password-strength-text');

    let strength = 0;
    let strengthLabel = '';
    let strengthColor = '';

    if (password.length >= 8) strength++;
    if (password.match(/[a-z]/)) strength++;
    if (password.match(/[A-Z]/)) strength++;
    if (password.match(/[0-9]/)) strength++;
    if (password.match(/[^a-zA-Z0-9]/)) strength++;

    switch(strength) {
        case 0:
        case 1:
            strengthLabel = 'Weak';
            strengthColor = '#F56565';
            break;
        case 2:
        case 3:
            strengthLabel = 'Fair';
            strengthColor = '#ED8936';
            break;
        case 4:
            strengthLabel = 'Good';
            strengthColor = '#48BB78';
            break;
        case 5:
            strengthLabel = 'Strong';
            strengthColor = '#38A169';
            break;
    }

    strengthBar.style.width = (strength / 5 * 100) + '%';
    strengthBar.style.backgroundColor = strengthColor;
    strengthText.textContent = strengthLabel;
    strengthText.style.color = strengthColor;
});

// Confirm password validation
document.getElementById('confirm_password').addEventListener('blur', function() {
    const password = document.getElementById('password').value;
    const confirmPassword = this.value;
    const errorSpan = document.getElementById('confirm-password-error');

    if (confirmPassword && password !== confirmPassword) {
        errorSpan.textContent = 'Passwords do not match';
        this.classList.add('form-input--error');
    } else {
        errorSpan.textContent = '';
        this.classList.remove('form-input--error');
    }
});

// Username validation
document.getElementById('username').addEventListener('blur', async function() {
    const username = this.value;
    const errorSpan = document.getElementById('username-error');

    if (username && !username.match(/^[A-Za-z0-9_-]{3,50}$/)) {
        errorSpan.textContent = 'Invalid username format';
        this.classList.add('form-input--error');
        return;
    }

    // Check username availability (optional async check)
    if (username.length >= 3) {
        try {
            const response = await fetch(`/api/v1/auth/check-username?username=${encodeURIComponent(username)}`);
            const data = await response.json();

            if (!data.available) {
                errorSpan.textContent = 'Username already taken';
                this.classList.add('form-input--error');
            } else {
                errorSpan.textContent = '';
                this.classList.remove('form-input--error');
            }
        } catch (error) {
            // Silently fail - server-side validation will catch it
        }
    }
});

// Email validation
document.getElementById('email').addEventListener('blur', function() {
    const email = this.value;
    const errorSpan = document.getElementById('email-error');

    if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        errorSpan.textContent = 'Please enter a valid email address';
        this.classList.add('form-input--error');
    } else {
        errorSpan.textContent = '';
        this.classList.remove('form-input--error');
    }
});

// Form submission with loading state
document.getElementById('register-form').addEventListener('submit', function(e) {
    const btn = document.getElementById('register-btn');
    const btnText = btn.querySelector('.btn__text');
    const btnLoader = btn.querySelector('.btn__loader');

    // Validate all fields
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;

    if (password !== confirmPassword) {
        e.preventDefault();
        document.getElementById('confirm-password-error').textContent = 'Passwords do not match';
        document.getElementById('confirm_password').classList.add('form-input--error');
        return;
    }

    // Show loading state
    btn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline-block';
});
</script>
{% endblock %}
