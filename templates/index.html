{% extends "base.html" %}

{% block title %}Home - Decentralized Autonomous Forum{% endblock %}

{% block content %}
<div class="home-page">
    <!-- Hero Section (for guests) -->
    {% if not current_user %}
    <section class="hero">
        <div class="container">
            <div class="hero__content">
                <h1 class="hero__title">Welcome to the Decentralized Forum</h1>
                <p class="hero__subtitle">
                    Earn crypto rewards, level up through contributions, and shape the community through
                    reputation-based governance. No admins, just community.
                </p>
                <div class="hero__cta">
                    <a href="/auth/register" class="btn btn--primary btn--lg">Get Started</a>
                    <a href="/explore" class="btn btn--secondary btn--lg">Explore Posts</a>
                </div>
                <div class="hero__features">
                    <div class="feature-card">
                        <svg class="feature-card__icon" width="32" height="32"><use xlink:href="#icon-crypto"/></svg>
                        <h3 class="feature-card__title">Earn BNB Rewards</h3>
                        <p class="feature-card__text">Convert points to cryptocurrency</p>
                    </div>
                    <div class="feature-card">
                        <svg class="feature-card__icon" width="32" height="32"><use xlink:href="#icon-user"/></svg>
                        <h3 class="feature-card__title">Level Up</h3>
                        <p class="feature-card__text">Gain moderation powers through reputation</p>
                    </div>
                    <div class="feature-card">
                        <svg class="feature-card__icon" width="32" height="32">
                            <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M16 8v8l4 4" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        <h3 class="feature-card__title">No Admins</h3>
                        <p class="feature-card__text">Community-driven moderation</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Main Content -->
    <div class="container">
        <div class="feed-layout">
            <!-- Sidebar (Left) -->
            <aside class="sidebar sidebar--left">
                <!-- Categories/Channels -->
                <div class="card">
                    <h2 class="card__title">Popular Channels</h2>
                    <nav class="channel-list">
                        <a href="/channel/general" class="channel-item channel-item--active">
                            <span class="channel-item__icon">#</span>
                            <span class="channel-item__name">General</span>
                            <span class="channel-item__count">1.2k</span>
                        </a>
                        <a href="/channel/crypto" class="channel-item">
                            <span class="channel-item__icon">#</span>
                            <span class="channel-item__name">Crypto</span>
                            <span class="channel-item__count">854</span>
                        </a>
                        <a href="/channel/technology" class="channel-item">
                            <span class="channel-item__icon">#</span>
                            <span class="channel-item__name">Technology</span>
                            <span class="channel-item__count">632</span>
                        </a>
                        <a href="/channel/offtopic" class="channel-item">
                            <span class="channel-item__icon">#</span>
                            <span class="channel-item__name">Off-Topic</span>
                            <span class="channel-item__count">427</span>
                        </a>
                    </nav>
                    <a href="/channels" class="card__link">View all channels ‚Üí</a>
                </div>

                <!-- Point Economy Info -->
                {% if current_user %}
                <div class="card card--highlight">
                    <h2 class="card__title">Your Progress</h2>
                    <div class="progress-widget">
                        <div class="progress-widget__stat">
                            <span class="progress-widget__label">Current Points</span>
                            <span class="progress-widget__value points-value">{{ current_user.points }}</span>
                        </div>
                        <div class="progress-widget__stat">
                            <span class="progress-widget__label">Level</span>
                            <span class="progress-widget__value user-level user-level--{{ current_user.level }}">
                                {{ current_user.level.value.replace('_', ' ').title() }}
                            </span>
                        </div>
                        <div class="progress-widget__bar">
                            <div class="progress-bar">
                                <div class="progress-bar__fill" data-width="{{ ((current_user.points % 1000) / 1000 * 100) }}"></div>
                            </div>
                            <span class="progress-widget__text">{{ 1000 - (current_user.points % 1000) }} points to next level</span>
                        </div>
                        <a href="/rewards" class="btn btn--primary btn--sm btn--block">View Rewards</a>
                    </div>
                </div>
                {% endif %}
            </aside>

            <!-- Main Feed -->
            <main class="feed">
                <!-- Feed Header -->
                <div class="feed-header">
                    <h1 class="feed-header__title">Latest Posts</h1>
                    <div class="feed-header__actions">
                        <div class="filter-tabs">
                            <button class="filter-tab {% if current_filter == 'hot' %}filter-tab--active{% endif %}" data-filter="hot">üî• Hot</button>
                            <button class="filter-tab {% if current_filter == 'new' %}filter-tab--active{% endif %}" data-filter="new">‚ú® New</button>
                            <button class="filter-tab {% if current_filter == 'top' %}filter-tab--active{% endif %}" data-filter="top">üèÜ Top</button>
                        </div>
                        {% if current_user %}
                        <a href="/posts/create" class="btn btn--primary btn--sm">
                            <svg width="16" height="16"><path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                            New Post
                        </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Post List -->
                <div class="post-list">
                    {% for post in posts %}
                    <article class="post-card">
                        <!-- Post Votes/Actions (Left) -->
                        <div class="post-card__actions">
                            <button class="vote-btn vote-btn--up {% if post.user_vote == 'upvote' %}vote-btn--active{% endif %}"
                                    aria-label="Upvote"
                                    data-post-id="{{ post.id }}">
                                <svg width="20" height="20"><path d="M10 4l6 8H4l6-8z" fill="currentColor"/></svg>
                            </button>
                            <span class="vote-count" data-count="{{ post.like_count }}">{{ post.like_count }}</span>
                            <button class="vote-btn vote-btn--down {% if post.user_vote == 'downvote' %}vote-btn--active{% endif %}"
                                    aria-label="Downvote"
                                    data-post-id="{{ post.id }}">
                                <svg width="20" height="20"><path d="M10 16l6-8H4l6 8z" fill="currentColor"/></svg>
                            </button>
                        </div>

                        <!-- Post Content -->
                        <div class="post-card__content">
                            <!-- Post Meta -->
                            <div class="post-card__meta">
                                <a href="/profile/{{ post.author.username }}" class="user-link">
                                    <img src="{{ post.author.avatar_url or url_for('static', path='/images/default-avatar.svg') }}"
                                         alt="{{ post.author.username }}'s avatar"
                                         class="user-link__avatar">
                                    <span class="user-link__username">{{ post.author.username }}</span>
                                    <span class="user-link__level user-level user-level--{{ post.author.level }}">
                                        {{ post.author.level.value.replace('_', ' ').title() }}
                                    </span>
                                </a>
                                <span class="post-card__separator">‚Ä¢</span>
                                <time class="post-card__time" datetime="{{ post.created_at.isoformat() }}">
                                    {{ post.created_at | timeago }}
                                </time>
                                {% if post.channel %}
                                <span class="post-card__separator">‚Ä¢</span>
                                <a href="/channel/{{ post.channel.slug }}" class="post-card__channel">
                                    #{{ post.channel.name }}
                                </a>
                                {% endif %}
                            </div>

                            <!-- Post Title -->
                            <h2 class="post-card__title">
                                <a href="/posts/{{ post.id }}" class="post-card__title-link">{{ post.title }}</a>
                            </h2>

                            <!-- Post Excerpt -->
                            {% if post.body_preview %}
                            <p class="post-card__excerpt">{{ post.body_preview }}</p>
                            {% endif %}

                            <!-- Post Media (if exists) -->
                            {% if post.media %}
                            <div class="post-card__media">
                                {% if post.media[0].type == 'image' %}
                                <img src="{{ post.media[0].url }}" alt="Post image" class="post-card__image">
                                {% elif post.media[0].type == 'video' %}
                                <video src="{{ post.media[0].url }}" controls class="post-card__video"></video>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Post Tags -->
                            {% if post.tags %}
                            <div class="post-card__tags">
                                {% for tag in post.tags[:3] %}
                                <a href="/tag/{{ tag.name }}" class="tag">{{ tag.name }}</a>
                                {% endfor %}
                                {% if post.tags | length > 3 %}
                                <span class="tag tag--more">+{{ post.tags | length - 3 }} more</span>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Post Footer -->
                            <div class="post-card__footer">
                                <a href="/posts/{{ post.id }}#comments" class="post-card__stat">
                                    <svg width="16" height="16"><use xlink:href="#icon-comment"/></svg>
                                    {{ post.comment_count }} comments
                                </a>
                                <button class="post-card__action" title="Share">
                                    <svg width="16" height="16"><use xlink:href="#icon-share"/></svg>
                                    Share
                                </button>
                                <button class="post-card__action" title="Bookmark">
                                    <svg width="16" height="16"><use xlink:href="#icon-bookmark"/></svg>
                                    Save
                                </button>
                                {% if current_user and (current_user.id == post.author.id or current_user.level in ['moderator', 'senior_moderator']) %}
                                <div class="post-card__dropdown">
                                    <button class="post-card__action" aria-label="More options">
                                        <svg width="16" height="16"><circle cx="8" cy="4" r="1.5" fill="currentColor"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="8" cy="12" r="1.5" fill="currentColor"/></svg>
                                    </button>
                                    <div class="dropdown-menu">
                                        {% if current_user.id == post.author.id %}
                                        <a href="/posts/{{ post.id }}/edit" class="dropdown-item">Edit</a>
                                        <button class="dropdown-item dropdown-item--danger" data-action="delete" data-post-id="{{ post.id }}">Delete</button>
                                        {% endif %}
                                        {% if current_user.level in ['moderator', 'senior_moderator'] %}
                                        <button class="dropdown-item" data-action="report" data-post-id="{{ post.id }}">Report</button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                    {% else %}
                    <!-- Empty State -->
                    <div class="empty-state">
                        <svg class="empty-state__icon" width="64" height="64">
                            <circle cx="32" cy="32" r="30" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M20 32h24M32 20v24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <h2 class="empty-state__title">No posts yet</h2>
                        <p class="empty-state__text">Be the first to start a discussion!</p>
                        {% if current_user %}
                        <a href="/posts/create" class="btn btn--primary">Create First Post</a>
                        {% else %}
                        <a href="/auth/register" class="btn btn--primary">Sign Up to Post</a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if posts and total_pages > 1 %}
                <nav class="pagination" aria-label="Page navigation">
                    <ul class="pagination__list">
                        <li class="pagination__item">
                            <a href="?page={{ page - 1 }}" class="pagination__link {% if page <= 1 %}pagination__link--disabled{% endif %}" aria-label="Previous page">
                                <svg width="16" height="16"><path d="M10 4l-4 4 4 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                Previous
                            </a>
                        </li>
                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                            <li class="pagination__item">
                                <span class="pagination__link pagination__link--active">{{ p }}</span>
                            </li>
                            {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
                            <li class="pagination__item">
                                <a href="?page={{ p }}" class="pagination__link">{{ p }}</a>
                            </li>
                            {% elif p == 4 or p == total_pages - 3 %}
                            <li class="pagination__item">
                                <span class="pagination__ellipsis">...</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        <li class="pagination__item">
                            <a href="?page={{ page + 1 }}" class="pagination__link {% if page >= total_pages %}pagination__link--disabled{% endif %}" aria-label="Next page">
                                Next
                                <svg width="16" height="16"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            </main>

            <!-- Sidebar (Right) -->
            <aside class="sidebar sidebar--right">
                <!-- Leaderboard -->
                <div class="card">
                    <h2 class="card__title">üèÜ Top Contributors</h2>
                    <ol class="leaderboard">
                        {% for user in top_users[:5] %}
                        <li class="leaderboard__item">
                            <span class="leaderboard__rank">{{ loop.index }}</span>
                            <a href="/profile/{{ user.username }}" class="leaderboard__user">
                                <img src="{{ user.avatar_url or url_for('static', path='/images/default-avatar.svg') }}"
                                     alt="{{ user.username }}'s avatar"
                                     class="leaderboard__avatar">
                                <div class="leaderboard__info">
                                    <span class="leaderboard__username">{{ user.username }}</span>
                                    <span class="leaderboard__points">{{ user.points }} pts</span>
                                </div>
                            </a>
                        </li>
                        {% endfor %}
                    </ol>
                    <a href="/leaderboard" class="card__link">View full leaderboard ‚Üí</a>
                </div>

                <!-- Stats -->
                <div class="card">
                    <h2 class="card__title">üìä Community Stats</h2>
                    <dl class="stats-list">
                        <div class="stats-item">
                            <dt class="stats-item__label">Total Members</dt>
                            <dd class="stats-item__value">{{ stats.total_users | number_format }}</dd>
                        </div>
                        <div class="stats-item">
                            <dt class="stats-item__label">Total Posts</dt>
                            <dd class="stats-item__value">{{ stats.total_posts | number_format }}</dd>
                        </div>
                        <div class="stats-item">
                            <dt class="stats-item__label">BNB Distributed</dt>
                            <dd class="stats-item__value">{{ stats.total_bnb_distributed }} BNB</dd>
                        </div>
                        <div class="stats-item">
                            <dt class="stats-item__label">Active Today</dt>
                            <dd class="stats-item__value">{{ stats.active_today | number_format }}</dd>
                        </div>
                    </dl>
                </div>

                <!-- Help/Resources -->
                <div class="card card--info">
                    <h2 class="card__title">üí° New here?</h2>
                    <ul class="link-list">
                        <li><a href="/help/getting-started" class="link-list__link">Getting Started Guide</a></li>
                        <li><a href="/help/point-economy" class="link-list__link">Understanding Points</a></li>
                        <li><a href="/help/community-guidelines" class="link-list__link">Community Guidelines</a></li>
                        <li><a href="/help/faq" class="link-list__link">FAQ</a></li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>
</div>

<!-- Additional SVG Icons -->
<svg style="display: none;">
    <defs>
        <symbol id="icon-comment" viewBox="0 0 16 16">
            <path d="M2 2h12a1 1 0 011 1v8a1 1 0 01-1 1H5l-3 3V3a1 1 0 011-1z" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
        </symbol>
        <symbol id="icon-share" viewBox="0 0 16 16">
            <circle cx="4" cy="8" r="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <circle cx="12" cy="4" r="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <circle cx="12" cy="12" r="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M6 7l4-2m-4 4l4 2" stroke="currentColor" stroke-width="1.5"/>
        </symbol>
        <symbol id="icon-bookmark" viewBox="0 0 16 16">
            <path d="M3 2h10v12l-5-3-5 3V2z" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
        </symbol>
    </defs>
</svg>
{% endblock %}

{% block extra_scripts %}
<script>
// Vote buttons
document.querySelectorAll('.vote-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const postId = this.dataset.postId;
        const voteType = this.classList.contains('vote-btn--up') ? 'upvote' : 'downvote';

        try {
            const response = await fetch(`/api/posts/${postId}/vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vote_type: voteType })
            });

            if (response.ok) {
                const data = await response.json();
                const voteCount = this.parentElement.querySelector('.vote-count');
                voteCount.textContent = data.like_count;
                voteCount.dataset.count = data.like_count;

                // Update active state
                this.parentElement.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('vote-btn--active'));
                this.classList.add('vote-btn--active');
            }
        } catch (error) {
            console.error('Vote error:', error);
        }
    });
});

// Filter tabs
document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const filter = this.dataset.filter;
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('filter-tab--active'));
        this.classList.add('filter-tab--active');
        window.location.href = `/?filter=${filter}`;
    });
});

// Progress bar width from data attribute
document.querySelectorAll('.progress-bar__fill[data-width]').forEach(fill => {
    const width = fill.dataset.width;
    fill.style.width = width + '%';
});
</script>
{% endblock %}
